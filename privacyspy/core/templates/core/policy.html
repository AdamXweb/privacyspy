{% load humanize %}

{% if policy == None %}
<div class="notification is-danger">
    {% with "Add a policy for " as policy_message %}
    Our database does not contain a privacy policy for this product. <a
        href="{% url 'create_suggestion' %}?text={{policy_message|urlencode}}{{product.name|urlencode}}">Click here</a>
    to suggest we add one. <i>(Note: only registered users can suggest changes.)</i>
    {% endwith %}
</div>
{% else %}
<div class="tabs">
    <ul>
        <li class="has-text-weight-medium"><a href="#policy-overview">Overview</a></li>
        <li><a class="has-text-weight-medium" href="#policy-ratings">Ratings</a></li>
        <li><a class="has-text-weight-medium" href="#warnings">Warnings {% if product.has_active_warning %}
            &nbsp;
            <span class="has-text-danger">
                <i class="fas fa-exclamation-circle"
                    title="A high or medium severity warning was published for this product in the last 6 months"></i>
            </span>
            {% endif %}</a></li>
        <li><a class="has-text-weight-medium" href="#policy-revisions">Revisions</a></li>
        <li><a class="has-text-weight-medium" href="#policy-highlights">Highlights</a></li>
        <li><a class="has-text-weight-medium" href="{% url 'create_suggestion' %}?policy={{policy.id}}">Suggest Edit</a>
        </li>
        {% if is_maintainer or user.is_superuser %}
        <li><a class="has-text-weight-medium" href="{% url 'edit_policy' policy.id %}">Edit</a></li>
        {% endif %}
    </ul>
</div>
<div class="columns reverse-order-columns">
    <div class="column is-8">
        <br>
        {% if policy.product.current_policy != policy %}
        <div class="notification is-warning">
            You are viewing an archived version of this product's privacy policy, created
            {{policy.updated|naturalday}}. To view the most recent version, <a
                href="{% url 'product' product_slug=policy.product.slug %}">click here</a>.
        </div>
        {% endif %}
        <section id="policy-ratings">
            {% with policy.rubric_selections as rubric_selections %}
            {% if rubric_selections|length != 0 %}
            {% endif %}
            {% for selection in rubric_selections %}
            {% include 'core/rubric_selection.html' %}
            {% empty %}
            <div class="notification">
                No ratings have been established for this privacy policy. Try selecting a different revision or product.
            </div>
            {% endfor %}
            {% endwith %}
        </section>
        {% with policy.parse_highlights as highlights %}
        <br>
        <section id="warnings">
            <h4 class="subtitle is-size-4" id="warnings">Warnings</h4>
            {% for warning in policy.product.warnings %}
            {% include 'core/warning.html' %}
            {% empty %}
            <article class="message is-success">
                <div class="message-body">
                    <strong>{{policy.product.name}} has no warnings published on
                        PrivacySpy.</strong> PrivacySpy publishes warnings when it learns a service has announced a data
                    breach or is found misusing user data. If you believe a warning should be published for
                    {{policy.product.name}}, <a
                        href="{% url 'create_suggestion' %}?policy={{policy.id}}&text=WARNING%20SUGGESTION%0A%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%0AEvent%3A%20%28what%20happened%3F%29%0AReferences%3A%20%28links%20to%20news%20stories%20about%20it%3F%29">submit
                        one here</a>.
                </div>
              </article>
            {% endfor %}
        </section>
        <br><br>
        <section id="policy-highlights">
            <h4 class="subtitle is-size-4" id="policy-highlights">Highlighted Privacy Policy</h4>
            {% include 'core/highlights.html'%}
            {% endwith %}
        </section>

    </div>
    <div class="column is-offset-1 is-centered-mobile">
        <div id="policy-overview">
            <h3 class="is-size-1 is-marginless has-text-weight-bold {{policy.color}}">
                <span class="policy-score">
                    {% if policy.score > -1 %}
                    {{policy.score|floatformat:"-1"}}<span class="has-text-grey has-text-weight-normal">/10</span>
                    {% else %}
                    Unrated
                    {% endif %}
                </span>
            </h3>
            <div class="policy-column-stat top-pad">
                <div class="heading">Version Added</div>
                <p>{{policy.added|naturalday|capfirst}}</p>
            </div>
            <div class="policy-column-stat">
                <div class="heading">Ratings Updated</div>
                <p>{{policy.updated|naturalday|capfirst}}</p>
            </div>
            <div class="policy-column-stat">
                <div class="heading">Warnings</div>
                <p>{{policy.product.warnings|length}}</p>
            </div>
            <div class="policy-column-stat">
                <div class="heading">Maintained by</div>
                <p>{% if policy.product.maintainers.all|length == 0 %}Admins{% else %}{{policy.product.maintainers.all|join:", "}}{% endif %}</p>
            </div>
            <div class="policy-column-stat">
                <div class="heading">Original Location</div>
                <a class="button is-dark is-small is-outlined" href="{{policy.original_url}}" target="_blank">Open in
                    New
                    Tab</a>
            </div>
            <div class="policy-column-stat" id="policy-revisions">
                <div class="heading">Revisions</div>
                <div class="dropdown is-hoverable">
                    <div class="dropdown-trigger">
                        <button class="button is-small is-dark is-outlined" aria-haspopup="true"
                            aria-controls="dropdown-menu4">
                            <span>Select Revision</span>
                            <span class="icon is-small">
                                <i class="fas fa-angle-down" aria-hidden="true"></i>
                            </span>
                        </button>
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu4" role="menu">
                        <div class="dropdown-content">
                            <a href="{% url 'product' product_slug=policy.product.slug %}"
                                class="dropdown-item {% if policy.product.current_policy == policy %}is-active{% endif %}">Latest</a>
                            <hr class="dropdown-divider">
                            {% with policy.product.revisions as revisions %}
                            {% for revision in revisions %}
                            <a href="{% url 'product' policy.product.slug %}?revision={{revision.id}}"
                                class="dropdown-item {% if policy == revision %}is-active{% endif %}">{{revision.added|naturalday|capfirst}}</a>
                            {% empty %}
                            <p class="dropdown-item has-text-grey">PrivacySpy has no other revisions of this privacy
                                policy
                                in its database.</p>
                            {% endfor %}
                            {% if revisions %}
                            <hr class="dropdown-divider">
                            <p class="dropdown-item has-text-grey">Note that the times listed above are when the policy
                                revision was added to PrivacySpy, not when it was originally published or last updated.
                            </p>
                            {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}